<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1 minimal-ui">
<meta name="description" content="World Quest">
<meta name="author" content="Atsushi Sakai">
<meta name="keywords" content="Atsushi Sakai,MyEnigma,World" >


<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="white">
<link href="static/css/bootstrap.min.css" rel="stylesheet">
<link rel="shortcut icon" href="https://dl.dropboxusercontent.com/u/2393628/githubpages/WorldQuest/iconified/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://dl.dropboxusercontent.com/u/2393628/githubpages/WorldQuest/iconified/apple-touch-icon-152x152.png"/>

<!--
TODO
-->

<script type="text/javascript">
  var geocoder;
  function initialize() {
    //localStorage.clear();
    geocoder = new google.maps.Geocoder();
    var DB = JSON.parse(localStorage.getItem("DB"));
    console.log(localStorage.getItem("DB"));
    if(DB!=null){
      kenDB=DB.kenDB;
      timeDB=DB.timeDB;
    }

    drawScore();
    drawTable();
  }

  function setJsonDB(){
    var storage=localStorage.getItem("DB");
    if(storage==null){
      var text='<button class="close" data-dismiss="modal">×</button>';
      text+="<h3>他のスマホなどからデータを移行する場合</h3>";
      text+="下記のスペースにコピーしてきたテキストデータをペーストして、Submitボタンを押して下さい";
      document.getElementById("migration").innerHTML=text;
      text2='<input type="text" id="jsondata" class="form-control" placeholder="ここにテキストをペーストして下さい">'
      document.getElementById("jsonform").innerHTML=text2;
      text3='<input type="submit" value="Submit" class="btn btn-primary" data-dismiss="modal" onClick="SetLocalStrage()">';
      document.getElementById("migrationfooter").innerHTML=text3;
    }
    else{
      var text='<button class="close" data-dismiss="modal">×</button>';
      text+="<h3>他のスマホなどにデータを移行する方法</h3>";
      text+="<ol><li>下記のコードをコピーする</li>";
      text+="<li>このコードをメールなどで他の端末に送り、コピーする</li>";
      text+="<li>他の端末でWorld Questアプリを起動する.</li>"
      text+="<li>Data Migrationボタンを押してデータをペーストする</li></ol>";

      document.getElementById("migration").innerHTML=text;
      document.getElementById("jsonform").innerHTML=localStorage.getItem("DB");
      document.getElementById("migrationfooter").innerHTML="";
    }
  }

  //終了処理
  window.onbeforeunload = function(){
    var DB={
      kenDB: kenDB,
      timeDB: timeDB,
    }
    localStorage.setItem("DB", JSON.stringify(DB));
    //console.log(localStorage.getItem("DB"));
  }

</script>

<link href="static/css/bootstrap.min.css" rel="stylesheet">
<title>World Quest</title>
</head>
<body onload="initialize()">
<div class="navbar navbar-inverse navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://myenigma.hatenablog.com/">
        <img style="vertical-align:middle;" height="28" src="https://dl.dropboxusercontent.com/u/2393628/heroku/common/myenigmaLogo.png"/></a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-left">
        <li class="hidden">
        <a href="#page-top"></a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://myenigma.hatenablog.com/entry/2015/07/05/091654">本サービスの詳しい使い方</a></li>
        <li><a data-toggle="modal" href="#myModal" onClick="setJsonDB()">データ移行ツール</a></li>
        <li><a href="http://atsushisakai.github.io/">その他Webツール</a></li>
      </ul>
    </div><!--/.navbar-collapse -->
  </div>
</div>



<div class="container" style="padding:10px 0">
  <div class="container">

  <div class="jumbotron">
    <h1>World Quest</h1>
    スマホのGPSを使って、47都道府県を制覇するゲームです。
  </div>

  <div class="form-group">
    <label class="control-label" for="imageurl">ボタンをクリックして、今いる都道府県を制覇しましょう <i class="glyphicon glyphicon-hand-right"></i></label>
    <button class="btn btn-primary" data-toggle="modal" href="#myModal" onClick="getPosition()"><i class="glyphicon glyphicon-screenshot"></i> Get Position</button>
  </div>

  <div id="message"></div>

  <div class="panel panel-primary"><div class="panel-heading"><h3 class="panel-title">
        あなたのスコア
  </h3></div>
  <div class="panel-body" id="score"></div>
  </div>

  <div id="drawChart"></div>

  <h2>都道府県制覇履歴</h2>
  <table class="table table-striped table-bordered" id="histTable">
  <thead>
    <tr>
      <th>#</th>
      <th>都道府県</th>
      <th>制覇日</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
  </table>

  <h2>Other Users Quest</h2>
  <div class="container">
<a class="twitter-timeline" href="https://twitter.com/hashtag/WorldQuest" data-widget-id="620069009879252993">#WorldQuest のツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>

  <div class="modal fade" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" id="migration">
        </div>
        <div class="modal-body" id="jsonform">
          しばしお待ちください...
        </div>
        <div class="modal-footer" id="migrationfooter">
        </div>
      </div>
    </div>
  </div>

  <!--TweetButton-->
  <a href="https://twitter.com/share" class="twitter-share-button" data-size="large">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <!-- hatena button -->
  <a href="http://b.hatena.ne.jp/entry/http://atsushisakai.github.io/WorldQuest/" class="hatena-bookmark-button" data-hatena-bookmark-title="World Quest" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

  <!--署名-->
  <footer>
    <address>
      For more details and requests, contact
      <a href="https://twitter.com/atsushi_twi">@Atsushi_twi</a>.
    </address>
    <p><small>(c) copyright 2015.</small></p>
  </footer>

  </div>

  </html>

  <!-- Google Adscense -->
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-9612347954373886"
    data-ad-slot="3722314056"
    data-ad-format="auto"></ins>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});

  </script>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>
<script src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load('visualization', '1', {packages:['geochart']});
google.setOnLoadCallback(graphChart);
google.load("maps");

var kenDB=[['都道府県', 'Get']];
var timeDB=[];

function SetLocalStrage(){
  var json=document.getElementById("jsondata").value;
  console.log(json);
  localStorage.setItem("DB", json);

  var DB = JSON.parse(localStorage.getItem("DB"));
  console.log(localStorage.getItem("DB"));
  if(DB!=null){
    kenDB=DB.kenDB;
    timeDB=DB.timeDB;
  }

  drawScore();
  drawTable();
}

function drawScore(){
  document.getElementById('score').innerHTML="<h1>"+(kenDB.length-1)+"/47都道府県制覇しました</h1>";
}

function getPosition() {
  //Geolocation APIに対応している
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(callback1);
  }else{
    //現在位置を取得できない場合の処理
    alert("あなたの端末では、現在位置を取得できません。");
  }

  var DB={
      kenDB: kenDB,
      timeDB: timeDB,
  }

  try{
    localStorage.setItem("DB", JSON.stringify(DB));
    console.log(localStorage.getItem("DB"));
  }
  catch(e){
    console.log(e);
    console.log("local strage error");
  }
}

function drawTable(){
  var table = document.getElementById('histTable');

  var str="";
  var id=1;

  //一行目以外を削除
  while( table.rows.length >= 2 ){
    table.deleteRow( 1 );
  }

  for(d in timeDB){
    var newtr = table.insertRow( table.rows.length );

    var newtd = newtr.insertCell( newtr.cells.length );
    newtd.appendChild( document.createTextNode(id) );

    var newtd = newtr.insertCell( newtr.cells.length );
    newtd.appendChild( document.createTextNode(kenDB[id][0]) );

    var newtd = newtr.insertCell( newtr.cells.length );
    newtd.appendChild( document.createTextNode(timeDB[id-1]) );
    id++;
  }
}

function getTimeString(){

  var dateobj=new Date(); 

  var year   = dateobj.getFullYear();
  var month  = dateobj.getMonth()+1;
  var day    = dateobj.getDate();
  var hour   = dateobj.getHours();
  var minute = dateobj.getMinutes();
  var second = dateobj.getSeconds();

  var timestr=year+"/"+month+"/"+day+" "+hour+":"+minute+":"+second;

  return timestr
}

function callback1(position) {
	lat = position.coords.latitude;
	lon = position.coords.longitude;
	var latlng = new google.maps.LatLng(lat, lon);
  var ken;
	geocoder.geocode({'latLng':latlng},function(results,status){
		if (status == google.maps.GeocoderStatus.OK) {
      result 	= '現在地の取得に成功しました<br>';
      result += '経度：' + lat + '<br>';
      result += '緯度：' + lon + '<br>';
      result += '住所：' + results[2].formatted_address + '<br>';

      var address=results[2].address_components; 
      var kenstore;

      for (var i = 0; i < address.length; i++) { 
        switch (address[i].types[0]) { 
          case "administrative_area_level_1": 
            $("#administrative_area_level_1").text(address[i].long_name); 
			      ken  = address[i].long_name;
            kenstore=ken;
            ken = ken.replace(/県/g,"");
            ken = ken.replace(/都/g,"");
            ken = ken.replace(/道/g,"");
            ken = ken.replace(/府/g,"");

            find=false;
            for(ii=1;ii<kenDB.length;ii++){
              if(ken===kenDB[ii][0]){
                find=true
              }
            }

            if(!find){
              kenDB.push([ken,1]);
              time=getTimeString();
              timeDB.push(time);
            }
            else{
              result="すでに登録された都道府県です。"
            }
            break; 
        } 
      } 

      graphChart();
      drawScore();
      drawTable();

      var DB={
        kenDB: kenDB,
        timeDB: timeDB,
      }
      localStorage.setItem("DB", JSON.stringify(DB));

      console.log(find);
      SetPositionModal(find,result,kenstore);

        //alert(result);
		} else {
			console.log(status);
		}
	});
}

function SetPositionModal(find,result,kenstore){
  var text='<button class="close" data-dismiss="modal">×</button>';
  text+="<h3>位置情報取得結果</h3>";
  document.getElementById('migration').innerHTML = text;
  document.getElementById('jsonform').innerHTML = result;

  console.log(find);

  if(!find){
    text='<input type="submit" value="Tweet" class="btn btn-primary" onclick="window.open(';
    text+="'https://twitter.com/intent/tweet?hashtags=WorldQuest&text=";
    text+=(kenDB.length-1)+"つ目の都道府県『"+kenstore+"』を制覇しました!!全国制覇まであと"+(48-kenDB.length)+"都道府県です。";
    text+="&url=http://atsushisakai.github.io/WorldQuest/";
    text+=')">';
    //console.log(text);

    //text='<a href="https://twitter.com/share" class="twitter-share-button" data-size="large">Tweet</a>';
    document.getElementById('migrationfooter').innerHTML =text;
  }
}

function graphChart() {
  var data = google.visualization.arrayToDataTable(kenDB);
 
  var option = {
    region: 'JP',
    resolution: 'provinces'
  };
 
  var graph = new google.visualization.GeoChart(document.getElementById('drawChart'));
  graph.draw(data, option);
}
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65040805-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
